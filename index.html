<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unrealised CGT to Centric CSV Processor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;position:relative}
    .header{position:relative;background:linear-gradient(135deg,#5e72e4 0%,#825ee4 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2.5em;margin-bottom:10px}
    .header p{opacity:.9;font-size:1.1em}
    .refresh-btn{position:absolute;right:16px;top:16px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.35);color:#fff;padding:8px 14px;border-radius:999px;font-weight:600;cursor:pointer;backdrop-filter:blur(4px)}
    .refresh-btn:hover{background:rgba(255,255,255,.25)}
    .main-content{padding:40px}
    .format-selector{background:#f8f9ff;padding:20px;border-radius:10px;margin-bottom:30px;display:flex;align-items:center;gap:20px}
    .format-selector label{font-weight:600;color:#555}
    .format-selector select{padding:10px 15px;border:2px solid #667eea;border-radius:8px;font-size:1em;background:#fff;cursor:pointer;min-width:240px}
    .format-selector select:focus{outline:none;border-color:#825ee4;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .upload-section{border:3px dashed #667eea;border-radius:15px;padding:40px;text-align:center;transition:.3s;background:#f8f9ff;cursor:pointer}
    .upload-section:hover{border-color:#825ee4;background:#f0f2ff}
    .upload-section.dragover{background:#e8ebff;transform:scale(1.02)}
    .upload-icon{font-size:4em;color:#667eea;margin-bottom:20px}
    .file-input{display:none}
    .upload-label{display:inline-block;padding:12px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:25px;cursor:pointer;transition:transform .3s;font-weight:600}
    .upload-label:hover{transform:translateY(-2px)}
    .file-list{margin-top:30px}
    .file-item{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:15px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;transition:.3s}
    .file-item:hover{box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .file-info{display:flex;align-items:center;gap:15px}
    .file-icon{font-size:2em;color:#667eea}
    .btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:600;transition:.3s}
    .btn-remove{background:#ff4757;color:#fff}.btn-remove:hover{background:#ff3838}
    .btn-process{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-size:1.1em;padding:15px 40px;border-radius:25px;margin-top:20px}
    .btn-process:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.4)}
    .btn-process:disabled{opacity:.5;cursor:not-allowed}
    .results-section{margin-top:40px;display:none}
    .results-header{background:#f8f9ff;padding:20px;border-radius:10px;margin-bottom:20px}
    .asset-card{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:20px;margin-bottom:20px;transition:.3s}
    .asset-card:hover{box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .asset-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
    .asset-name{font-size:1.2em;font-weight:600;color:#333}
    .asset-count{background:#667eea;color:#fff;padding:5px 15px;border-radius:15px;font-size:.9em}
    .table-container{overflow-x:auto;margin-top:15px}
    table{width:100%;border-collapse:collapse}
    th{background:#f8f9ff;padding:12px;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #e0e0e0}
    td{padding:10px 12px;border-bottom:1px solid #f0f0f0}
    tr:hover{background:#fafbff}
    .btn-download{background:linear-gradient(135deg,#00d2ff 0%,#3a7bd5 100%);color:#fff;padding:8px 20px;border-radius:20px;font-size:.9em}
    .btn-download:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(58,123,213,.4)}
    .loading{display:none;text-align:center;padding:40px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .status-message{margin-top:20px;padding:15px;border-radius:10px;display:none}
    .status-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .status-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    .debug-section{margin-top:20px;padding:20px;background:#f8f9ff;border-radius:10px;display:none}
    .debug-content{font-family:monospace;font-size:.9em;white-space:pre-wrap;max-height:300px;overflow-y:auto;background:#fff;padding:10px;border-radius:5px;margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Unrealised CGT to Centric Processor</h1>
      <p>Convert Unrealised Capital Gains reports to Centric-compatible CSV format</p>
      <button class="refresh-btn" onclick="location.reload()">‚Üª Refresh</button>
    </div>

    <div class="main-content">
      <div class="format-selector">
        <label for="formatSelect">Report Format:</label>
        <select id="formatSelect">
          <option value="findex">Findex SMSF Report</option>
          <option value="external">External SMSF Report</option>
          <option value="lifefocus">LifeFocus Report</option>
        </select>
        <span style="color:#666;font-size:.9em;">Select your report format</span>
      </div>

      <div id="uploadSection" class="upload-section">
        <div class="upload-icon">üìÅ</div>
        <h2>Upload Unrealised CGT Reports</h2>
        <p style="margin:20px 0;color:#666;">Drag & drop PDF files here or click to browse</p>
        <label for="fileInput" class="upload-label">Choose Files</label>
        <input id="fileInput" class="file-input" type="file" accept=".pdf" multiple />
        <p style="margin-top:20px;color:#999;font-size:.9em;">Supports Findex, External, and LifeFocus formats</p>
      </div>

      <div id="fileList" class="file-list"></div>

      <div style="text-align:center;">
        <button id="processBtn" class="btn btn-process" style="display:none;" onclick="processFiles()">Process Files</button>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Processing your files...</p>
      </div>

      <div id="statusMessage" class="status-message"></div>

      <div id="debugSection" class="debug-section">
        <h3>Debug Output</h3>
        <div id="debugContent" class="debug-content"></div>
      </div>

      <div id="resultsSection" class="results-section">
        <div class="results-header">
          <h2>üìà Processed Tax Parcels</h2>
          <p style="margin-top:10px;color:#666;">Review the extracted data and download CSV files for each asset</p>
        </div>
        <div id="resultsContainer"></div>
      </div>
    </div>
  </div>

  <script>
    let uploadedFiles = [];
    let processedData = {};
    let debugMode = true;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const uploadSection = document.getElementById('uploadSection');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const processBtn = document.getElementById('processBtn');
    const formatSelect = document.getElementById('formatSelect');

    uploadSection.addEventListener('dragover', e => { e.preventDefault(); uploadSection.classList.add('dragover'); });
    uploadSection.addEventListener('dragleave', () => uploadSection.classList.remove('dragover'));
    uploadSection.addEventListener('drop', e => { e.preventDefault(); uploadSection.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    uploadSection.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files){
      for (const f of files) if (f.type === 'application/pdf') uploadedFiles.push(f);
      updateFileList();
    }
    function updateFileList(){
      fileList.innerHTML = '';
      if (!uploadedFiles.length){ processBtn.style.display='none'; return; }
      processBtn.style.display='inline-block';
      uploadedFiles.forEach((file, i) => {
        const el = document.createElement('div');
        el.className='file-item';
        el.innerHTML = `
          <div class="file-info">
            <div class="file-icon">üìÑ</div>
            <div>
              <div style="font-weight:600;">${file.name}</div>
              <div style="color:#999;font-size:.9em;">${(file.size/1024).toFixed(2)} KB</div>
            </div>
          </div>
          <button class="btn btn-remove" onclick="removeFile(${i})">Remove</button>
        `;
        fileList.appendChild(el);
      });
    }
    function removeFile(i){ uploadedFiles.splice(i,1); updateFileList(); }

    async function processFiles(){
      if (!uploadedFiles.length) return;
      document.getElementById('loading').style.display='block';
      document.getElementById('resultsSection').style.display='none';
      if (debugMode) document.getElementById('debugSection').style.display='block';
      processedData = {}; processBtn.disabled = true;
      try{
        for (const file of uploadedFiles) await processPDF(file);
        displayResults(); showStatus('Files processed successfully!','success');
      }catch(err){
        console.error(err); showStatus('Error processing files. See console.', 'error');
        if (debugMode) addDebugInfo('Error: '+err.message);
      }finally{
        document.getElementById('loading').style.display='none';
        processBtn.disabled = false;
      }
    }

    async function processPDF(file){
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      let fullText = '';
      for (let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(it=>it.str).join(' ');
        fullText += pageText + '\n';
      }
      if (debugMode) addDebugInfo(`Extracted from ${file.name}:\n${fullText.substring(0,500)}`);

      const fmt = formatSelect.value;
      if (fmt === 'findex') parseFindexFormat(fullText);
      else if (fmt === 'external') parseExternalFormat(fullText);
      else if (fmt === 'lifefocus') parseLifeFocusFormat(fullText);
    }

    function addDebugInfo(t){
      const d=document.getElementById('debugContent');
      d.textContent += t + '\n\n';
    }

    /* ---------------- External SMSF Report (unchanged) ---------------- */
    function parseExternalFormat(text){
      if (debugMode) addDebugInfo('Parsing as External SMSF Report...');
      const headers=[];
      const fundPattern=/([A-Z]{3}\d{4}[A-Z]{2}\d*)\s*[-‚Äì]\s*([^0-9\n]+)/g;
      let m; while((m=fundPattern.exec(text))!==null){ headers.push({code:m[1],name:m[2].trim(),position:m.index}); }
      const stockPattern=/([A-Z]{2,6}\.[A-Z]{2}\d*)\s*[-‚Äì]\s*([^0-9\n]+)/g;
      while((m=stockPattern.exec(text))!==null){ headers.push({code:m[1],name:m[2].trim(),position:m.index}); }
      headers.sort((a,b)=>a.position-b.position);
      if (debugMode) addDebugInfo(`Found ${headers.length} total assets`);

      for (let i=0;i<headers.length;i++){
        const cur=headers[i];
        const nextPos = i<headers.length-1 ? headers[i+1].position : text.length;
        const section = text.substring(cur.position, nextPos);
        if (!processedData[cur.code]) processedData[cur.code]=[];

        const dateRe=/(\d{2}\/\d{2}\/\d{4})/g;
        let dmt; const dates=[];
        while((dmt=dateRe.exec(section))!==null){ dates.push({date:dmt[1],pos:dmt.index}); }

        dates.forEach((dObj, idx)=>{
          const start=dObj.pos, end= idx<dates.length-1 ? dates[idx+1].pos : section.length;
          const row = section.substring(start,end).replace(/\d{2}\/\d{2}\/\d{4}/,'').trim();
          const numRe=/\(?([\d,]+\.?\d*)\)?/g;
          const nums=[...row.matchAll(numRe)].map(mm=>{
            const val=parseFloat(mm[1].replace(/,/g,'')); return isNaN(val)?null:val;
          }).filter(v=>v!==null);

          if (nums.length>=5){
            const units=nums[1], cost3=nums[2], rcb5=nums[4];
            if (units>0 && cost3>0){
              processedData[cur.code].push({
                instrumentCode: cur.code, instrumentName: cur.name, type:'Open Tax Parcel',
                quantity: units, acquisitionDate: dObj.date,
                costBase: rcb5, reducedCostBase: cost3
              });
            }
          } else if (nums.length>=3){
            const units=nums[1] ?? nums[0], cost=nums[2] ?? nums[1];
            if (units>0 && cost>0){
              processedData[cur.code].push({
                instrumentCode: cur.code, instrumentName: cur.name, type:'Open Tax Parcel',
                quantity: units, acquisitionDate: dObj.date,
                costBase: cost, reducedCostBase: cost
              });
            }
          }
        });
      }
      Object.keys(processedData).forEach(k=>{ if(!processedData[k].length) delete processedData[k]; });
    }

    /* ---------------- FINDEX SMSF Report (RCB = Amount column) ---------------- */
    function parseFindexFormat(text){
      if (debugMode) addDebugInfo('Parsing as Findex SMSF Report...');
      const assetRe=/([A-Za-z\.\s&]+?)\s*\(ASX:([A-Z]{2,6})\)/g;
      const assets=[...text.matchAll(assetRe)];
      if (debugMode) addDebugInfo(`Found ${assets.length} assets with ASX codes`);
      assets.forEach((am, idx)=>{
        const name=am[1].trim(), code=am[2].trim();
        const start=am.index, end= idx<assets.length-1 ? assets[idx+1].index : text.length;
        const section=text.substring(start,end);
        if (!processedData[code]) processedData[code]=[];

        // Find all dates inside this asset block
        const dateRe=/\b(\d{2}\/\d{2}\/\d{4})\b/g;
        const dateHits=[...section.matchAll(dateRe)];
        for (let i=0;i<dateHits.length;i++){
          const date=dateHits[i][1];
          const rowStart=dateHits[i].index + date.length; // start just after the date
          const rowEnd = i<dateHits.length-1 ? dateHits[i+1].index : section.length;
          const slice = section.substring(rowStart, rowEnd);

          // extract up to ~20 numeric tokens after the date
          const tokRe=/\-?\(?\$?\d{1,3}(?:,\d{3})*(?:\.\d+)?\)?/g;
          const tokens=[...slice.matchAll(tokRe)].map(t=>{
            const s=t[0].replace(/\$/g,'').replace(/\(|\)/g,'').replace(/,/g,'');
            const v=parseFloat(s); return isNaN(v)?null:v;
          }).filter(v=>v!==null);

          // Expected order: [0]=Qty, [1]=Market, [2]=OriginalCost, [3]=AcctGain, [4]=TaxFree, [5]=TaxDeferred, [6]=AMIT, [7]=Amount (RCB)
          if (tokens.length>=8){
            const qty=tokens[0], costBase=tokens[2], rcb=tokens[7];
            if (qty>0 && costBase>0){
              processedData[code].push({
                instrumentCode: code, instrumentName: name, type:'Open Tax Parcel',
                quantity: qty, acquisitionDate: date,
                costBase: costBase, reducedCostBase: rcb
              });
              if (debugMode) addDebugInfo(`FINDEX row -> ${code} ${date} qty=${qty} cost=${costBase} rcb=${rcb}`);
            }
          } else {
            // fallback similar to previous approach
            if (tokens.length>=3){
              const qty=tokens[0], costBase=tokens[2];
              if (qty>0 && costBase>0){
                processedData[code].push({
                  instrumentCode: code, instrumentName: name, type:'Open Tax Parcel',
                  quantity: qty, acquisitionDate: date,
                  costBase: costBase, reducedCostBase: costBase
                });
              }
            }
          }
        }
      });
      Object.keys(processedData).forEach(k=>{ if(!processedData[k].length) delete processedData[k]; });
    }

    /* ---------------- LifeFocus Report ----------------
       - Start parsing from "Unrealised CGT (current tax year as at"
       - Rows: Purchase date | Purchase cost | No. units | Unit price date | Unit price $ | Current balance $ | Estimated unrealised gain/loss $
       - Output: Type=Open Tax Parcel; Acquisition Date=Purchase date; Quantity=No. units; CostBase=Purchase cost; ReducedCostBase=Purchase cost
    ---------------------------------------------------*/
    function parseLifeFocusFormat(text){
      if (debugMode) addDebugInfo('Parsing as LifeFocus Report...');
      const anchor = text.indexOf('Unrealised CGT (current tax year as at');
      if (anchor < 0){ if (debugMode) addDebugInfo('LifeFocus anchor not found.'); return; }
      const tail = text.substring(anchor);

      // Split into instrument sections (e.g., "BlackRock Glob Allocation Fd Aus Class D (MAL0018AU)")
      const instRe = /([A-Za-z0-9\.\-,'&/ ]+?)\s*\(([A-Z0-9]{6,})\)\s*(?=\d{2}-[A-Z]{3}-\d{4}|\n|$)/g;
      const matches=[...tail.matchAll(instRe)];

      for (let i=0;i<matches.length;i++){
        const name = matches[i][1].trim().replace(/\s+/g,' ');
        const code = matches[i][2].trim();
        const start = matches[i].index + matches[i][0].length;
        const end = i<matches.length-1 ? matches[i+1].index : tail.length;
        const block = tail.substring(start, end);

        if (!processedData[code]) processedData[code]=[];

        // Row pattern: 07-MAY-2008 $23,000.00 19,068.148 17-JAN-2025 1.30984 24,976.22 2,627.11
        const rowRe = /\b(\d{2}-[A-Z]{3}-\d{4})\b\s+\$?([\d,]+\.\d{2})\s+([\d,]+\.\d{3})/g;
        let r;
        while((r=rowRe.exec(block))!==null){
          const date = r[1];
          const purchaseCost = parseFloat(r[2].replace(/,/g,''));
          const units = parseFloat(r[3].replace(/,/g,''));
          if (!isNaN(purchaseCost) && purchaseCost>0 && !isNaN(units) && units>0){
            processedData[code].push({
              instrumentCode: code, instrumentName: name, type:'Open Tax Parcel',
              quantity: units, acquisitionDate: date,
              costBase: purchaseCost, reducedCostBase: purchaseCost
            });
            if (debugMode) addDebugInfo(`LifeFocus row -> ${code} ${date} qty=${units} cost=${purchaseCost}`);
          }
        }
      }
      Object.keys(processedData).forEach(k=>{ if(!processedData[k].length) delete processedData[k]; });
    }

    /* ---------------- Results + CSV ---------------- */
    function displayResults(){
      const rc=document.getElementById('resultsContainer');
      rc.innerHTML='';
      const keys=Object.keys(processedData);
      if (!keys.length){
        rc.innerHTML='<p style="text-align:center;color:#999;">No tax parcels found. Check the format selector and debug output.</p>';
        document.getElementById('resultsSection').style.display='block';
        return;
      }
      keys.sort().forEach(code=>{
        const parcels=processedData[code]; if (!parcels.length) return;
        const name=parcels[0].instrumentName||code;
        const card=document.createElement('div'); card.className='asset-card';
        card.innerHTML = `
          <div class="asset-header">
            <div>
              <div class="asset-name">${code}</div>
              <div style="color:#666;font-size:.9em;margin-top:5px;">${name}</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
              <div class="asset-count">${parcels.length} parcels</div>
              <button class="btn btn-download" onclick="downloadCSV('${code}')">Download CSV</button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Type</th><th>Quantity</th><th>Acquisition Date</th><th>Cost Base ($)</th><th>Reduced Cost Base ($)</th>
                </tr>
              </thead>
              <tbody>
                ${parcels.map(p=>`
                  <tr>
                    <td>${p.type}</td>
                    <td>${p.quantity.toFixed(3)}</td>
                    <td>${p.acquisitionDate}</td>
                    <td>$${p.costBase.toFixed(2)}</td>
                    <td>$${p.reducedCostBase.toFixed(2)}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>`;
        rc.appendChild(card);
      });
      document.getElementById('resultsSection').style.display='block';
    }

    function downloadCSV(code){
      const rows=processedData[code]; if (!rows?.length) return;
      const csvData = rows.map(r=>({
        'Instrument Code': code,
        'Type': r.type,
        'Number of Shares/ Units': r.quantity,
        'Acquisition Date': r.acquisitionDate,
        'Disposal Date': '',
        'Cost Base ($)': r.costBase,
        'Reduced Cost Base ($)': r.reducedCostBase,
        'Disposal Cost ($)': '',
        'Cost Base(AUD)': r.costBase,
        'Reduced Cost Base(AUD)': r.reducedCostBase,
        'Disposal Cost (AUD)': '',
        'Tax parcel ID': ''
      }));
      const csv=Papa.unparse(csvData);
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`${code}_tax_parcels.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      showStatus(`Downloaded ${code}_tax_parcels.csv`,'success');
    }

    function showStatus(msg,type){
      const el=document.getElementById('statusMessage');
      el.textContent=msg; el.className=`status-message status-${type}`; el.style.display='block';
      setTimeout(()=>{ el.style.display='none'; },5000);
    }
  </script>
</body>
</html>
