<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unrealised CGT to Centric CSV Processor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding:20px;
    }
    .container {
      max-width: 1200px; margin:0 auto; background:#fff; border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.3); overflow:hidden;
    }
    .header {
      position:relative;
      background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
      color:#fff; padding:30px; text-align:center;
    }
    .header h1 { font-size:2.5em; margin-bottom:10px; }
    .header p { opacity:.9; font-size:1.1em; }
    .refresh-btn {
      position:absolute; top:18px; right:20px;
      padding:10px 16px; border:none; border-radius:22px;
      background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      color:#fff; font-weight:700; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    .refresh-btn:hover { transform: translateY(-1px); }
    .main-content { padding:40px; }
    .format-selector{
      background:#f8f9ff; padding:20px; border-radius:10px; margin-bottom:30px;
      display:flex; align-items:center; gap:20px;
    }
    .format-selector label{ font-weight:600; color:#555; }
    .format-selector select{
      padding:10px 15px; border:2px solid #667eea; border-radius:8px; font-size:1em;
      background:#fff; cursor:pointer; min-width:240px;
    }
    .format-selector select:focus{
      outline:none; border-color:#825ee4; box-shadow:0 0 0 3px rgba(102,126,234,.1);
    }
    .upload-section{
      border:3px dashed #667eea; border-radius:15px; padding:40px; text-align:center;
      transition:all .3s ease; background:#f8f9ff; cursor:pointer;
    }
    .upload-section:hover{ border-color:#825ee4; background:#f0f2ff; }
    .upload-section.dragover{ background:#e8ebff; transform:scale(1.02); }
    .upload-icon{ font-size:4em; color:#667eea; margin-bottom:20px; }
    .file-input{ display:none; }
    .upload-label{
      display:inline-block; padding:12px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; border-radius:25px; cursor:pointer; transition:transform .3s ease; font-weight:600;
    }
    .upload-label:hover{ transform: translateY(-2px); }
    .file-list{ margin-top:30px; }
    .file-item{
      background:#fff; border:1px solid #e0e0e0; border-radius:10px; padding:15px;
      margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;
      transition:all .3s ease;
    }
    .file-item:hover{ box-shadow:0 5px 15px rgba(0,0,0,.1); }
    .file-info{ display:flex; align-items:center; gap:15px; }
    .file-icon{ font-size:2em; color:#667eea; }
    .btn{ padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:600; transition:all .3s ease; }
    .btn-process{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; font-size:1.1em; padding:15px 40px; border-radius:25px; margin-top:20px;
    }
    .btn-process:hover{ transform: translateY(-2px); box-shadow:0 10px 20px rgba(102,126,234,.4); }
    .btn-process:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-remove{ background:#ff4757; color:#fff; }
    .btn-remove:hover{ background:#ff3838; }
    .results-section{ margin-top:40px; display:none; }
    .results-header{ background:#f8f9ff; padding:20px; border-radius:10px; margin-bottom:20px; }
    .asset-card{
      background:#fff; border:1px solid #e0e0e0; border-radius:10px; padding:20px; margin-bottom:20px;
      transition:all .3s ease;
    }
    .asset-card:hover{ box-shadow:0 5px 15px rgba(0,0,0,.1); }
    .asset-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:15px; border-bottom:2px solid #f0f0f0; }
    .asset-name{ font-size:1.2em; font-weight:600; color:#333; }
    .asset-count{ background:#667eea; color:#fff; padding:5px 15px; border-radius:15px; font-size:.9em; }
    .table-container{ overflow-x:auto; margin-top:15px; }
    table{ width:100%; border-collapse:collapse; }
    th{
      background:#f8f9ff; padding:12px; text-align:left; font-weight:600; color:#555; border-bottom:2px solid #e0e0e0;
    }
    td{ padding:10px 12px; border-bottom:1px solid #f0f0f0; }
    tr:hover{ background:#fafbff; }
    .btn-download{
      background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      color:#fff; padding:8px 20px; border-radius:20px; font-size:.9em;
    }
    .btn-download:hover{ transform: translateY(-2px); box-shadow:0 5px 15px rgba(58,123,213,.4); }
    .loading{ display:none; text-align:center; padding:40px; }
    .spinner{
      border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; width:50px; height:50px;
      animation:spin 1s linear infinite; margin:0 auto 20px;
    }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .status-message{ margin-top:20px; padding:15px; border-radius:10px; display:none; }
    .status-success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .status-error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .status-info{ background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }
    .debug-section{ margin-top:20px; padding:20px; background:#f8f9ff; border-radius:10px; display:none; }
    .debug-content{ font-family:monospace; font-size:.9em; white-space:pre-wrap; max-height:300px; overflow-y:auto; background:#fff; padding:10px; border-radius:5px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Unrealised CGT to Centric Processor</h1>
      <p>Convert Unrealised Capital Gains reports to Centric-compatible CSV format</p>
      <button class="refresh-btn" id="refreshBtn" title="Refresh">‚Üª Refresh</button>
    </div>

    <div class="main-content">
      <div class="format-selector">
        <label for="formatSelect">Report Format:</label>
        <select id="formatSelect">
          <option value="findex">Findex SMSF Report</option>
          <option value="external">External SMSF Report</option>
          <option value="lifefocus">LifeFocus Report</option>
        </select>
        <span style="color:#666;font-size:.9em;">Pick your report type (no auto-detect)</span>
      </div>

      <div class="upload-section" id="uploadSection">
        <div class="upload-icon">üìÅ</div>
        <h2>Upload Unrealised CGT Reports</h2>
        <p style="margin:20px 0;color:#666;">Drag & drop PDF files here or click to browse</p>
        <label for="fileInput" class="upload-label">Choose Files</label>
        <input type="file" id="fileInput" class="file-input" accept=".pdf" multiple />
        <p style="margin-top:20px;color:#999;font-size:.9em;">Supports Findex, External, and LifeFocus formats</p>
      </div>

      <div class="file-list" id="fileList"></div>

      <div style="text-align:center;">
        <button class="btn btn-process" id="processBtn" style="display:none;" onclick="processFiles()">Process Files</button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing your files...</p>
      </div>

      <div class="status-message" id="statusMessage"></div>

      <div class="debug-section" id="debugSection">
        <h3>Debug Output</h3>
        <div class="debug-content" id="debugContent"></div>
      </div>

      <div class="results-section" id="resultsSection">
        <div class="results-header">
          <h2>üìà Processed Tax Parcels</h2>
          <p style="margin-top:10px;color:#666;">Review the extracted data and download CSV files for each asset</p>
        </div>
        <div id="resultsContainer"></div>
      </div>
    </div>
  </div>

  <script>
    // Globals
    let uploadedFiles = [];
    let processedData = {};
    let debugMode = true;

    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // UI elements
    const uploadSection = document.getElementById('uploadSection');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const processBtn = document.getElementById('processBtn');
    const formatSelect = document.getElementById('formatSelect');

    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', () => {
      location.reload();
    });

    // Drag & drop
    uploadSection.addEventListener('dragover', (e) => { e.preventDefault(); uploadSection.classList.add('dragover'); });
    uploadSection.addEventListener('dragleave', () => uploadSection.classList.remove('dragover'));
    uploadSection.addEventListener('drop', (e) => {
      e.preventDefault(); uploadSection.classList.remove('dragover'); handleFiles(e.dataTransfer.files);
    });
    uploadSection.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files){
      for (let f of files) if (f.type === 'application/pdf') uploadedFiles.push(f);
      updateFileList();
    }
    function updateFileList(){
      fileList.innerHTML = '';
      if (!uploadedFiles.length){ processBtn.style.display='none'; return; }
      processBtn.style.display='inline-block';
      uploadedFiles.forEach((file, idx) => {
        const el = document.createElement('div');
        el.className='file-item';
        el.innerHTML = `
          <div class="file-info">
            <div class="file-icon">üìÑ</div>
            <div>
              <div style="font-weight:600;">${file.name}</div>
              <div style="color:#999;font-size:.9em;">${(file.size/1024).toFixed(2)} KB</div>
            </div>
          </div>
          <button class="btn btn-remove" onclick="removeFile(${idx})">Remove</button>
        `;
        fileList.appendChild(el);
      });
    }
    function removeFile(i){ uploadedFiles.splice(i,1); updateFileList(); }

    async function processFiles(){
      if (!uploadedFiles.length) return;
      document.getElementById('loading').style.display='block';
      document.getElementById('resultsSection').style.display='none';
      if (debugMode) document.getElementById('debugSection').style.display='block';
      processBtn.disabled = true; processedData = {};
      try{
        for (let file of uploadedFiles) await processPDF(file);
        displayResults();
        showStatus('Files processed successfully!', 'success');
      }catch(err){
        console.error(err);
        showStatus('Error processing files. Check console/debug output.', 'error');
        if (debugMode) addDebugInfo('Error: ' + err.message);
      }finally{
        document.getElementById('loading').style.display='none';
        processBtn.disabled = false;
      }
    }

    async function processPDF(file){
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++){
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(it => it.str).join(' ');
        fullText += pageText + '\n';
      }
      if (debugMode) addDebugInfo(`Extracted text from ${file.name} (first 600 chars):\n${fullText.substring(0,600)}`);

      const selectedFormat = formatSelect.value;
      if (selectedFormat === 'findex') parseFindexFormat(fullText);
      else if (selectedFormat === 'external') parseExternalFormat(fullText);
      else if (selectedFormat === 'lifefocus') parseLifeFocusFormat(fullText);
    }

    function addDebugInfo(t){
      const d = document.getElementById('debugContent');
      d.textContent += t + '\n\n';
    }

    // ---------- External (unchanged) ----------
    function parseExternalFormat(text){
      if (debugMode) addDebugInfo('Parsing as External SMSF Report...');
      const assetHeaders = [];
      const fundPattern = /([A-Z]{3}\d{4}[A-Z]{2}\d*)\s*[-‚Äì]\s*([^0-9\n]+)/g;
      let m;
      while ((m = fundPattern.exec(text)) !== null){
        assetHeaders.push({ code:m[1], name:m[2].trim(), position:m.index });
      }
      const stockPattern = /([A-Z]{2,6}\.[A-Z]{2}\d*)\s*[-‚Äì]\s*([^0-9\n]+)/g;
      while ((m = stockPattern.exec(text)) !== null){
        assetHeaders.push({ code:m[1], name:m[2].trim(), position:m.index });
      }
      assetHeaders.sort((a,b)=>a.position-b.position);
      for (let i=0;i<assetHeaders.length;i++){
        const a = assetHeaders[i];
        const nextPos = i<assetHeaders.length-1 ? assetHeaders[i+1].position : text.length;
        const section = text.substring(a.position, nextPos);
        if (!processedData[a.code]) processedData[a.code]=[];
        const dateRe = /(\d{2}\/\d{2}\/\d{4})/g; let dm; const dates=[];
        while ((dm=dateRe.exec(section))!==null) dates.push({date:dm[1], pos:dm.index});
        dates.forEach((dObj, idx)=>{
          const start=dObj.pos, end = idx<dates.length-1 ? dates[idx+1].pos : section.length;
          const dateSection = section.substring(start,end).replace(/\d{2}\/\d{2}\/\d{4}/,'').trim();
          const numRe = /\(?([\d,]+\.?\d*)\)?/g;
          const nums = [...dateSection.matchAll(numRe)]
            .map(mm => parseFloat(mm[1].replace(/,/g,'')))
            .filter(v => !isNaN(v));
          if (nums.length>=5){
            const units = nums[1], cb3 = nums[2], rcb5=nums[4];
            if (units>0 && cb3>0){
              processedData[a.code].push({
                instrumentCode:a.code, instrumentName:a.name, type:'Open Tax Parcel',
                quantity: units, acquisitionDate: dObj.date,
                costBase: rcb5, reducedCostBase: cb3
              });
            }
          }else if (nums.length>=3){
            const units = nums[1] ?? nums[0], cb = nums[2] ?? nums[1];
            if (units>0 && cb>0){
              processedData[a.code].push({
                instrumentCode:a.code, instrumentName:a.name, type:'Open Tax Parcel',
                quantity: units, acquisitionDate: dObj.date,
                costBase: cb, reducedCostBase: cb
              });
            }
          }
        });
      }
      Object.keys(processedData).forEach(k => { if (!processedData[k].length) delete processedData[k]; });
    }

    // ---------- FINDEX (fix only Reduced Cost Base) ----------
    function parseFindexFormat(text){
      if (debugMode) addDebugInfo('Parsing as Findex SMSF Report...');
      const assetRe = /([A-Za-z\.\s&]+?)\s*\(ASX:([A-Z]{2,6})\)/g;
      const holdingRe =
        /(\d{2}\/\d{2}\/\d{4})\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(?:\s+([\d,]+\.?\d*))?(?:\s+([\d,]+\.?\d*))?(?:\s+([\d,]+\.?\d*))?/g;

      const assets = [...text.matchAll(assetRe)];
      const allHoldings = [...text.matchAll(holdingRe)];

      assets.forEach((am, idx)=>{
        const name = am[1].trim(), code = am[2].trim();
        const start = am.index, end = (idx<assets.length-1) ? assets[idx+1].index : text.length;
        const section = text.substring(start, end);
        if (!processedData[code]) processedData[code]=[];

        allHoldings.forEach(hm=>{
          if (hm.index <= start || hm.index >= end) return;

          const date = hm[1];
          const num1 = parseFloat(hm[2].replace(/,/g,''));   // after-date numbers
          const num2 = parseFloat(hm[3].replace(/,/g,''));
          const num3 = parseFloat(hm[4].replace(/,/g,''));
          const aIdxInSection = hm.index - start;

          // quantity & cost base (UNCHANGED)
          let quantity, costBase;
          if (num2 > num1 * 2){ quantity = num1; costBase = num3; }
          else if (num1 > num2 * 2){ quantity = num2; costBase = num3; }
          else { quantity = num1; costBase = num3; }

          // Reduced Cost Base: take the CBC "Amount" immediately before the date
          const windowStart = Math.max(0, aIdxInSection - 160);
          const windowEnd   = Math.min(section.length, aIdxInSection + 20);
          const around = section.substring(windowStart, windowEnd);
          const datePos = around.indexOf(date);
          const numTokRe = /\(?-?\d{1,3}(?:,\d{3})*(?:\.\d+)?\)?/g;
          const tokens = [];
          let m; while ((m = numTokRe.exec(around)) !== null){
            const raw = m[0];
            const val = parseFloat(raw.replace(/[(),]/g,''));
            if (!isNaN(val)) tokens.push({val, pos:m.index});
          }
          const pre = tokens.filter(t => t.pos < datePos);
          let reducedCostBase = costBase; // default fallback

          if (pre.length >= 2){
            // Use the SECOND number among the 4 closest pre-date numbers (typical CBC: [x, AMOUNT, 0, 0])
            const lastGroup = pre.slice(-4); // if fewer than 4, this returns what exists
            if (lastGroup.length >= 2){
              const candidate = lastGroup[1].val;
              if (candidate >= 0) reducedCostBase = candidate;
            }
          }

          if (quantity > 0 && costBase > 0){
            processedData[code].push({
              instrumentCode: code, instrumentName: name, type:'Open Tax Parcel',
              quantity, acquisitionDate: date, costBase, reducedCostBase
            });
            if (debugMode) addDebugInfo(`Added parcel ${code} ${date} qty=${quantity} CB=${costBase} RCB=${reducedCostBase}`);
          }
        });
      });

      Object.keys(processedData).forEach(k => { if (!processedData[k].length) delete processedData[k]; });
    }

    // ---------- LifeFocus ----------
    function parseLifeFocusFormat(text){
      if (debugMode) addDebugInfo('Parsing as LifeFocus Report...');
      const anchorIdx = text.indexOf('Unrealised CGT (current tax year as at');
      if (anchorIdx < 0){
        if (debugMode) addDebugInfo('LifeFocus section not found.');
        return;
      }
      const tail = text.substring(anchorIdx);
      const lines = tail.split(/\n+/);

      let currentCode = null, currentName = null, buf = [];

      const isHeader = (line) => {
        const m = line.match(/(.+?)\s*\(([^()]+)\)$/);
        if (!m) return null;
        return { name: m[1].trim(), code: m[2].trim() };
      };

      for (const raw of lines){
        const line = raw.trim();
        const hdr = isHeader(line);
        if (hdr){
          currentName = hdr.name;
          currentCode = hdr.code;
          if (!processedData[currentCode]) processedData[currentCode] = [];
          continue;
        }
        if (!currentCode) continue;
        if (/^Managed Investment$/i.test(line) || /^Share Investment$/i.test(line) || line === ''){
          buf = [];
          continue;
        }
        if (/^\d{2}-[A-Z]{3}-\d{4}$/.test(line)){ buf=[line]; continue; }
        if (buf.length > 0 && buf.length < 7){
          buf.push(line);
          if (buf.length === 7){
            const acquisitionDate = buf[0];
            const purchaseCost = parseFloat(buf[1].replace(/[^0-9.,-]/g,'').replace(/,/g,''));
            const units = parseFloat(buf[2].replace(/[^0-9.,-]/g,'').replace(/,/g,''));
            if (!isNaN(purchaseCost) && purchaseCost > 0 && !isNaN(units) && units > 0){
              processedData[currentCode].push({
                instrumentCode: currentCode,
                instrumentName: currentName,
                type: 'Open Tax Parcel',
                quantity: units,
                acquisitionDate,
                costBase: purchaseCost,
                reducedCostBase: purchaseCost
              });
              if (debugMode) addDebugInfo(`LifeFocus row -> ${currentCode} ${acquisitionDate} qty=${units} cost=${purchaseCost} name=${currentName}`);
            }
            buf = [];
          }
        }
      }
    }

    // ---------- Results / CSV ----------
    function displayResults(){
      const resultsContainer = document.getElementById('resultsContainer');
      resultsContainer.innerHTML = '';
      if (!Object.keys(processedData).length){
        resultsContainer.innerHTML = '<p style="text-align:center;color:#999;">No tax parcels found. Check format and debug output.</p>';
        document.getElementById('resultsSection').style.display='block';
        return;
      }
      Object.keys(processedData).sort().forEach(code=>{
        const parcels = processedData[code];
        if (!parcels.length) return;
        const card = document.createElement('div');
        card.className='asset-card';
        const name = parcels[0].instrumentName || code;
        card.innerHTML = `
          <div class="asset-header">
            <div>
              <div class="asset-name">${code}</div>
              <div style="color:#666;font-size:.9em;margin-top:5px;">${name}</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
              <div class="asset-count">${parcels.length} parcels</div>
              <button class="btn btn-download" onclick="downloadCSV('${code}')">Download CSV</button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Type</th><th>Quantity</th><th>Acquisition Date</th><th>Cost Base ($)</th><th>Reduced Cost Base ($)</th>
                </tr>
              </thead>
              <tbody>
                ${parcels.map(p=>`
                  <tr>
                    <td>${p.type}</td>
                    <td>${p.quantity.toFixed(3)}</td>
                    <td>${p.acquisitionDate}</td>
                    <td>$${p.costBase.toFixed(2)}</td>
                    <td>$${p.reducedCostBase.toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        resultsContainer.appendChild(card);
      });
      document.getElementById('resultsSection').style.display='block';
    }

    function downloadCSV(code){
      const parcels = processedData[code];
      if (!parcels || !parcels.length) return;
      const csvData = parcels.map(p=>({
        'Instrument Code': code,
        'Type': p.type,
        'Number of Shares/ Units': p.quantity,
        'Acquisition Date': p.acquisitionDate,
        'Disposal Date': '',
        'Cost Base ($)': p.costBase,
        'Reduced Cost Base ($)': p.reducedCostBase,
        'Disposal Cost ($)': '',
        'Cost Base(AUD)': p.costBase,
        'Reduced Cost Base(AUD)': p.reducedCostBase,
        'Disposal Cost (AUD)': '',
        'Tax parcel ID': ''
      }));
      const csv = Papa.unparse(csvData);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download=`${code}_tax_parcels.csv`; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
      showStatus(`Downloaded ${code}_tax_parcels.csv`, 'success');
    }

    function showStatus(message, type){
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = `status-message status-${type}`;
      el.style.display='block';
      setTimeout(()=>{ el.style.display='none'; }, 5000);
    }
  </script>
</body>
</html>
