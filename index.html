<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unrealised CGT to Centric CSV Processor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{position:relative;background:linear-gradient(135deg,#5e72e4 0%,#825ee4 100%);color:#fff;padding:30px;text-align:center}
    .header h1{font-size:2.5em;margin-bottom:10px}
    .header p{opacity:.9;font-size:1.1em}
    .refresh-btn{position:absolute;right:16px;top:16px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.35);color:#fff;padding:8px 14px;border-radius:999px;font-weight:600;cursor:pointer;backdrop-filter:blur(4px)}
    .refresh-btn:hover{background:rgba(255,255,255,.25)}
    .main-content{padding:40px}
    .format-selector{background:#f8f9ff;padding:20px;border-radius:10px;margin-bottom:30px;display:flex;align-items:center;gap:20px}
    .format-selector label{font-weight:600;color:#555}
    .format-selector select{padding:10px 15px;border:2px solid #667eea;border-radius:8px;font-size:1em;background:#fff;cursor:pointer;min-width:240px}
    .format-selector select:focus{outline:none;border-color:#825ee4;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .upload-section{border:3px dashed #667eea;border-radius:15px;padding:40px;text-align:center;transition:.3s;background:#f8f9ff;cursor:pointer}
    .upload-section:hover{border-color:#825ee4;background:#f0f2ff}
    .upload-section.dragover{background:#e8ebff;transform:scale(1.02)}
    .upload-icon{font-size:4em;color:#667eea;margin-bottom:20px}
    .file-input{display:none}
    .upload-label{display:inline-block;padding:12px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:25px;cursor:pointer;transition:transform .3s;font-weight:600}
    .upload-label:hover{transform:translateY(-2px)}
    .file-list{margin-top:30px}
    .file-item{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:15px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;transition:.3s}
    .file-item:hover{box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .file-info{display:flex;align-items:center;gap:15px}
    .file-icon{font-size:2em;color:#667eea}
    .btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:600;transition:.3s}
    .btn-process{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-size:1.1em;padding:15px 40px;border-radius:25px;margin-top:20px}
    .btn-process:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.4)}
    .btn-process:disabled{opacity:.5;cursor:not-allowed}
    .btn-remove{background:#ff4757;color:#fff}.btn-remove:hover{background:#ff3838}
    .results-section{margin-top:40px;display:none}
    .results-header{background:#f8f9ff;padding:20px;border-radius:10px;margin-bottom:20px}
    .asset-card{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:20px;margin-bottom:20px;transition:.3s}
    .asset-card:hover{box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .asset-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
    .asset-name{font-size:1.2em;font-weight:600;color:#333}
    .asset-code{color:#666;font-size:.9em;margin-top:5px}
    .asset-count{background:#667eea;color:#fff;padding:5px 15px;border-radius:15px;font-size:.9em}
    .table-container{overflow-x:auto;margin-top:15px}
    table{width:100%;border-collapse:collapse}
    th{background:#f8f9ff;padding:12px;text-align:left;font-weight:600;color:#555;border-bottom:2px solid #e0e0e0}
    td{padding:10px 12px;border-bottom:1px solid #f0f0f0}
    tr:hover{background:#fafbff}
    .btn-download{background:linear-gradient(135deg,#00d2ff 0%,#3a7bd5 100%);color:#fff;padding:8px 20px;border-radius:20px;font-size:.9em}
    .btn-download:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(58,123,213,.4)}
    .loading{display:none;text-align:center;padding:40px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .status-message{margin-top:20px;padding:15px;border-radius:10px;display:none}
    .status-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .status-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    .debug-section{margin-top:20px;padding:20px;background:#f8f9ff;border-radius:10px;display:none}
    .debug-content{font-family:monospace;font-size:.9em;white-space:pre-wrap;max-height:300px;overflow-y:auto;background:#fff;padding:10px;border-radius:5px;margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Unrealised CGT to Centric Processor</h1>
      <p>Convert Unrealised Capital Gains reports to Centric-compatible CSV format</p>
      <button class="refresh-btn" onclick="location.reload()">‚Üª Refresh</button>
    </div>

    <div class="main-content">
      <div class="format-selector">
        <label for="formatSelect">Report Format:</label>
        <select id="formatSelect">
          <option value="findex">Findex SMSF Report</option>
          <option value="external">External SMSF Report</option>
          <option value="lifefocus">LifeFocus Report</option>
        </select>
        <span style="color:#666;font-size:.9em;">Select report format</span>
      </div>

      <div class="upload-section" id="uploadSection">
        <div class="upload-icon">üìÅ</div>
        <h2>Upload Unrealised CGT Reports</h2>
        <p style="margin:20px 0;color:#666;">Drag & drop PDF files here or click to browse</p>
        <label for="fileInput" class="upload-label">Choose Files</label>
        <input type="file" id="fileInput" class="file-input" accept=".pdf" multiple />
        <p style="margin-top:20px;color:#999;font-size:.9em;">Supports Findex, External, and LifeFocus formats</p>
      </div>

      <div class="file-list" id="fileList"></div>

      <div style="text-align:center;">
        <button class="btn btn-process" id="processBtn" style="display:none;" onclick="processFiles()">Process Files</button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing your files...</p>
      </div>

      <div class="status-message" id="statusMessage"></div>

      <div class="debug-section" id="debugSection">
        <h3>Debug Output</h3>
        <div class="debug-content" id="debugContent"></div>
      </div>

      <div class="results-section" id="resultsSection">
        <div class="results-header">
          <h2>üìà Processed Tax Parcels</h2>
          <p style="margin-top:10px;color:#666;">Review the extracted data and download CSV files for each asset</p>
        </div>
        <div id="resultsContainer"></div>
      </div>
    </div>
  </div>

  <script>
    // Globals
    let uploadedFiles = [];
    let processedData = {};
    let debugMode = true;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const uploadSection = document.getElementById('uploadSection');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const processBtn = document.getElementById('processBtn');
    const formatSelect = document.getElementById('formatSelect');

    uploadSection.addEventListener('dragover', e => { e.preventDefault(); uploadSection.classList.add('dragover'); });
    uploadSection.addEventListener('dragleave', () => uploadSection.classList.remove('dragover'));
    uploadSection.addEventListener('drop', e => { e.preventDefault(); uploadSection.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    uploadSection.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files){
      for (const file of files) if (file.type === 'application/pdf') uploadedFiles.push(file);
      updateFileList();
    }
    function updateFileList(){
      fileList.innerHTML = '';
      if (!uploadedFiles.length){ processBtn.style.display='none'; return; }
      processBtn.style.display='inline-block';
      uploadedFiles.forEach((file, idx) => {
        const el = document.createElement('div');
        el.className = 'file-item';
        el.innerHTML = `
          <div class="file-info">
            <div class="file-icon">üìÑ</div>
            <div>
              <div style="font-weight:600;">${file.name}</div>
              <div style="color:#999;font-size:.9em;">${(file.size/1024).toFixed(2)} KB</div>
            </div>
          </div>
          <button class="btn btn-remove" onclick="removeFile(${idx})">Remove</button>
        `;
        fileList.appendChild(el);
      });
    }
    function removeFile(i){ uploadedFiles.splice(i,1); updateFileList(); }

    async function processFiles(){
      if (!uploadedFiles.length) return;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('resultsSection').style.display = 'none';
      if (debugMode) document.getElementById('debugSection').style.display = 'block';
      processBtn.disabled = true; processedData = {};
      try{
        for (const file of uploadedFiles) await processPDF(file);
        displayResults(); showStatus('Files processed successfully!','success');
      }catch(e){
        console.error(e); showStatus('Error processing files. See debug output.','error');
        if (debugMode) addDebugInfo('Error: ' + e.message);
      }finally{
        document.getElementById('loading').style.display = 'none';
        processBtn.disabled = false;
      }
    }

    async function processPDF(file){
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';
      for (let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      if (debugMode) addDebugInfo(`Extracted text from ${file.name} (first 600 chars):\n${fullText.substring(0,600)}`);

      const fmt = formatSelect.value;
      if (fmt === 'findex') parseFindex(fullText);
      else if (fmt === 'external') parseExternal(fullText);
      else if (fmt === 'lifefocus') parseLifeFocus(fullText);
    }

    function addDebugInfo(t){
      const box = document.getElementById('debugContent');
      box.textContent += t + '\n\n';
    }

    /* ---------------- External SMSF (unchanged) ---------------- */
    function parseExternal(text){
      const assetHeaders=[];
      const fundPattern=/([A-Z]{3}\d{4}[A-Z]{2}\d*)\s*[-‚Äì]\s*([^0-9\n]+)/g;
      let m; while((m=fundPattern.exec(text))!==null){ assetHeaders.push({code:m[1],name:m[2].trim(),position:m.index}); }
      const stockPattern=/([A-Z]{2,6}\.[A-Z]{2}\d*)\s*[-‚Äì]\s*([^0-9\n]+)/g;
      while((m=stockPattern.exec(text))!==null){ assetHeaders.push({code:m[1],name:m[2].trim(),position:m.index}); }
      assetHeaders.sort((a,b)=>a.position-b.position);

      for (let i=0;i<assetHeaders.length;i++){
        const a=assetHeaders[i];
        const next=i<assetHeaders.length-1?assetHeaders[i+1].position:text.length;
        const section=text.substring(a.position,next);
        if(!processedData[a.code]) processedData[a.code]=[];

        const dateRe=/(\d{2}\/\d{2}\/\d{4})/g; let dm; const dates=[];
        while((dm=dateRe.exec(section))!==null) dates.push({date:dm[1],pos:dm.index});

        dates.forEach((d,idx)=>{
          const start=d.pos, end=idx<dates.length-1?dates[idx+1].pos:section.length;
          const row=section.substring(start,end).replace(/\d{2}\/\d{2}\/\d{4}/,'').trim();
          const numRe=/\(?([\d,]+\.?\d*)\)?/g;
          const nums=[...row.matchAll(numRe)].map(mm=>parseFloat(mm[1].replace(/,/g,''))).filter(v=>!isNaN(v));
          if(nums.length>=5){
            const units=nums[1], cb3=nums[2], rcb5=nums[4];
            if(units>0&&cb3>0){
              processedData[a.code].push({instrumentCode:a.code,instrumentName:a.name,type:'Open Tax Parcel',quantity:units,acquisitionDate:d.date,costBase:rcb5,reducedCostBase:cb3});
            }
          }else if(nums.length>=3){
            const units=nums[1]??nums[0], cb=nums[2]??nums[1];
            if(units>0&&cb>0){
              processedData[a.code].push({instrumentCode:a.code,instrumentName:a.name,type:'Open Tax Parcel',quantity:units,acquisitionDate:d.date,costBase:cb,reducedCostBase:cb});
            }
          }
        });
      }
      for(const k of Object.keys(processedData)){ if(!processedData[k].length) delete processedData[k]; }
    }

    /* ---------------- FINDEX SMSF (fix ONLY RCB; keep quantity logic) ---------------- */
    function parseFindex(text){
      const assetRe=/([A-Za-z\.\s&]+?)\s*\(ASX:([A-Z]{2,6})\)/g;
      const assets=[...text.matchAll(assetRe)];
      if(!assets.length) return;

      assets.forEach((am,ai)=>{
        const name=am[1].trim(), code=am[2].trim();
        const start=am.index, end = ai<assets.length-1?assets[ai+1].index:text.length;
        const section=text.substring(start,end);
        if(!processedData[code]) processedData[code]=[];

        // Each row begins with dd/mm/yyyy then a long run of numbers.
        const rowRe=/(\d{2}\/\d{2}\/\d{4})((?:\s+[-()$,.\d]+){8,})/g;
        let rm;
        while((rm=rowRe.exec(section))!==null){
          const date=rm[1];
          const tail=rm[2];
          const toks=[...tail.matchAll(/-?\(?\d{1,3}(?:,\d{3})*(?:\.\d+)?\)?/g)]
            .map(t=>parseFloat(t[0].replace(/[(),]/g,'')))
            .filter(v=>!isNaN(v));

          // Mapping after the date:
          // 0: Quantity, 1: Market Value, 2: Original Cost (Cost Base), 3: Accounting Gain/Loss,
          // 4: Tax Free, 5: Tax Deferred, 6: AMIT, 7: Amount (RCB)
          if(toks.length>=8){
            const quantity=toks[0];
            const costBase=toks[2];
            const reduced=toks[7];
            if(quantity>0 && costBase>0){
              processedData[code].push({
                instrumentCode:code,instrumentName:name,type:'Open Tax Parcel',
                quantity:quantity, acquisitionDate:date,
                costBase:costBase, reducedCostBase:reduced
              });
            }
          }
        }
      });
      for(const k of Object.keys(processedData)){ if(!processedData[k].length) delete processedData[k]; }
    }

    /* ---------------- LifeFocus Report (restored + robust) ---------------- */
    function parseLifeFocus(text){
      // Find instrument headers like: "BlackRock ... (MAL0018AU)"
      const hdrRe=/([A-Za-z0-9.\-,'&/ ]+?)\s*\(([A-Z0-9]{6,})\)/g;
      const headers=[...text.matchAll(hdrRe)];
      if(!headers.length) return;

      headers.forEach((hm,hi)=>{
        const name=hm[1].trim().replace(/\s+/g,' ');
        const code=hm[2].trim();
        const start=hm.index+hm[0].length;
        const end=hi<headers.length-1?headers[hi+1].index:text.length;
        const block=text.substring(start,end);
        if(!processedData[code]) processedData[code]=[];

        // Row: DD-MMM-YYYY  $23,000.00  19,068.148  17-JAN-2025  1.30984  24,976.22  2,627.11
        const rowRe=/\b(\d{2}-[A-Z]{3}-\d{4})\b\s+\$?([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{3})?)/g;
        let m;
        while((m=rowRe.exec(block))!==null){
          const date=m[1];
          const cost=parseFloat(m[2].replace(/,/g,''));
          const units=parseFloat(m[3].replace(/,/g,''));
          if(!isNaN(cost)&&cost>0&&!isNaN(units)&&units>0){
            processedData[code].push({
              instrumentCode:code,instrumentName:name,type:'Open Tax Parcel',
              quantity:units,acquisitionDate:date,
              costBase:cost,reducedCostBase:cost
            });
          }
        }
      });
      for(const k of Object.keys(processedData)){ if(!processedData[k].length) delete processedData[k]; }
    }

    /* ---------------- Results + CSV ---------------- */
    function displayResults(){
      const resultsContainer=document.getElementById('resultsContainer');
      resultsContainer.innerHTML='';
      const keys=Object.keys(processedData);
      if(!keys.length){
        resultsContainer.innerHTML='<p style="text-align:center;color:#999;">No tax parcels found. Check format and debug output.</p>';
        document.getElementById('resultsSection').style.display='block';
        return;
      }
      keys.sort().forEach(code=>{
        const parcels=processedData[code]; if(!parcels.length) return;
        const name=parcels[0].instrumentName||code;
        const card=document.createElement('div'); card.className='asset-card';
        card.innerHTML=`
          <div class="asset-header">
            <div>
              <div class="asset-name">${name}</div>
              <div class="asset-code">${code}</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
              <div class="asset-count">${parcels.length} parcels</div>
              <button class="btn btn-download" onclick="downloadCSV('${code}')">Download CSV</button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Type</th><th>Quantity</th><th>Acquisition Date</th><th>Cost Base ($)</th><th>Reduced Cost Base ($)</th>
                </tr>
              </thead>
              <tbody>
                ${parcels.map(p=>`
                  <tr>
                    <td>${p.type}</td>
                    <td>${p.quantity.toFixed(3)}</td>
                    <td>${p.acquisitionDate}</td>
                    <td>$${p.costBase.toFixed(2)}</td>
                    <td>$${p.reducedCostBase.toFixed(2)}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>`;
        resultsContainer.appendChild(card);
      });
      document.getElementById('resultsSection').style.display='block';
    }

    function downloadCSV(code){
      const rows=processedData[code]; if(!rows?.length) return;
      const csvData=rows.map(r=>({
        'Instrument Code': code,
        'Type': r.type,
        'Number of Shares/ Units': r.quantity,
        'Acquisition Date': r.acquisitionDate,
        'Disposal Date': '',
        'Cost Base ($)': r.costBase,
        'Reduced Cost Base ($)': r.reducedCostBase,
        'Disposal Cost ($)': '',
        'Cost Base(AUD)': r.costBase,
        'Reduced Cost Base(AUD)': r.reducedCostBase,
        'Disposal Cost (AUD)': '',
        'Tax parcel ID': ''
      }));
      const csv=Papa.unparse(csvData);
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`${code}_tax_parcels.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showStatus(`Downloaded ${code}_tax_parcels.csv`,'success');
    }

    function showStatus(message,type){
      const el=document.getElementById('statusMessage');
      el.textContent=message;
      el.className=`status-message status-${type}`;
      el.style.display='block';
      setTimeout(()=>{ el.style.display='none'; },5000);
    }
  </script>
</body>
</html>
